// Advanced PDF Exporter with html2pdf.js
// Creates beautiful, professional PDFs with custom design

class PDFExporter {
  constructor() {
    this.defaultOptions = {
      margin: [10, 10, 10, 10],
      filename: `guide_${Date.now()}.pdf`,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        logging: false,
        letterRendering: true
      },
      jsPDF: {
        unit: "mm",
        format: "a4",
        orientation: "portrait",
        compress: true
      },
      pagebreak: {
        mode: ["avoid-all", "css", "legacy"],
        before: ".page-break-before",
        after: ".page-break-after",
        avoid: ".no-page-break"
      }
    };
  }

  // Load language and messages for localization (EN/NO)
  async initI18n() {
    if (this._i18n) return; // already loaded
    const en = {
      gen_pdf: 'ðŸ“„ Generating PDF...',
      pdf_success: 'âœ… PDF exported successfully!',
      pdf_fail: 'âŒ PDF export failed',
      cover_subtitle: 'Step-by-Step Guide',
      cover_screenshots: 'Screenshots',
      cover_created: 'Created',
      cover_generated_by: 'Generated by IUB',
      toc_title: 'Table of Contents',
      page: 'Page',
      step_of: 'Step {n} of {total}',
      no_description: 'No description available.',
      footer_title: 'âœ… Guide Complete!',
      footer_line1: "You've successfully completed all {count} steps.",
      footer_line2: 'Thank you for using this guide!',
      footer_generated_by: 'Generated by IUB v2.0.3',
      footer_support: 'ðŸ“§ Need help? Contact support',
      footer_website: 'ðŸŒ Visit our website for more guides',
      footer_rate: 'â­ Rate this guide and share your feedback',
      step_word: 'Step',
      pdf_min_success: 'âœ… Minimal PDF exported!'
    };
    const no = {
      gen_pdf: 'ðŸ“„ Genererer PDF...',
      pdf_success: 'âœ… PDF eksportert!',
      pdf_fail: 'âŒ PDF-eksport feilet',
      cover_subtitle: 'Trinn-for-trinn guide',
      cover_screenshots: 'Skjermbilder',
      cover_created: 'Opprettet',
      cover_generated_by: 'Generert av IUB',
      toc_title: 'Innholdsfortegnelse',
      page: 'Side',
      step_of: 'Steg {n} av {total}',
      no_description: 'Ingen beskrivelse.',
      footer_title: 'âœ… Guide fullfÃ¸rt! ',
      footer_line1: 'Du har fullfÃ¸rt alle {count} steg.',
      footer_line2: 'Takk for at du brukte denne guiden!',
      footer_generated_by: 'Generert av IUB v2.0.3',
      footer_support: 'ðŸ“§ Trenger du hjelp? Kontakt support',
      footer_website: 'ðŸŒ BesÃ¸k nettsiden vÃ¥r for flere guider',
      footer_rate: 'â­ Ranger denne guiden og del tilbakemeldinger',
      step_word: 'Steg',
      pdf_min_success: 'âœ… Minimal PDF eksportert!'
    };
    let lang = 'en';
    try {
      const res = await chrome.storage?.local?.get?.(['lang']);
      if (res && res.lang) lang = res.lang;
      else if (navigator.language?.toLowerCase().startsWith('no')) lang = 'no';
    } catch {}
    this._dicts = { en, no };
    this._i18n = lang === 'no' ? no : en;
  }

  T(key, params) {
    const base = (this._i18n && this._i18n[key]) || (this._dicts?.en?.[key]) || key;
    if (!params) return base;
    return Object.keys(params).reduce((s, k) => s.replaceAll(`{${k}}`, params[k]), base);
  }

  // Export current session as beautiful PDF
  async exportSession(session) {
    if (!session || !session.captures || session.captures.length === 0) {
      this.showNotification("âŒ No captures to export", "error");
      return;
    }

    // Check if html2pdf is available
    if (typeof html2pdf === 'undefined') {
      this.showNotification("âŒ PDF library not loaded. Please reload the extension.", "error");
      console.error("html2pdf is not defined. Make sure the extension is reloaded after CSP changes.");
      return;
    }

    await this.initI18n();
    this.showNotification(this.T('gen_pdf'), "info");

    // Create PDF content
    const pdfContent = this.createPDFContent(session);

    // Generate PDF
    try {
      const opt = {
        ...this.defaultOptions,
        filename: `${this.sanitizeFilename(session.captures[0]?.title || "guide")}.pdf`
      };

      await html2pdf().set(opt).from(pdfContent).save();

      this.showNotification(this.T('pdf_success'), "success");

      // Cleanup
      setTimeout(() => pdfContent.remove(), 100);
    } catch (error) {
      console.error("PDF export failed:", error);
      this.showNotification(this.T('pdf_fail'), "error");
    }
  }

  // Create beautifully designed PDF content
  createPDFContent(session) {
    const container = document.createElement("div");
    container.style.cssText = `
      all: initial;
      position: absolute;
      left: -9999px;
      top: 0;
      width: 210mm;
      background: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #1e293b;
      box-sizing: border-box;
    `;

    // Add cover page
    container.appendChild(this.createCoverPage(session));

    // Add table of contents
    container.appendChild(this.createTableOfContents(session));

    // Add steps with screenshots
    session.captures.forEach((capture, index) => {
      container.appendChild(this.createStepPage(capture, index + 1, session));
    });

    // Add footer page
    container.appendChild(this.createFooterPage(session));

    document.body.appendChild(container);
    return container;
  }

  // Create modern cover page
  createCoverPage(session) {
    const cover = document.createElement("div");
    cover.className = "pdf-cover-page page-break-after";
    cover.style.cssText = `
      all: revert;
      display: block;
      min-height: 297mm;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40mm;
      box-sizing: border-box;
    `;

    const innerWrapper = document.createElement("div");
    innerWrapper.style.cssText = `
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      min-height: 100%;
    `;

    const title =
      session.captures[0]?.title?.replace(/\.png$/i, "") || "User Guide";
    const date = new Date().toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });

    innerWrapper.innerHTML = `
      <div style="margin-bottom: 20mm;">
        <div style="font-size: 48pt; font-weight: 700; margin-bottom: 10mm; text-shadow: 0 4px 20px rgba(0,0,0,0.3);">
          ${this.escapeHtml(title)}
        </div>
        <div style="font-size: 18pt; font-weight: 400; opacity: 0.9;">
          ${this.T('cover_subtitle')}
        </div>
      </div>
      
      <div style="margin-top: 30mm; font-size: 14pt; opacity: 0.8;">
        <div style="margin-bottom: 5mm;">
          ðŸ“¸ ${session.captures.length} ${this.T('cover_screenshots')}
        </div>
        <div style="margin-bottom: 5mm;">
          ðŸ“… ${this.T('cover_created')}: ${date}
        </div>
        <div>
          ðŸš€ ${this.T('cover_generated_by')}
        </div>
      </div>
    `;

    cover.appendChild(innerWrapper);
    return cover;
  }

  // Create table of contents
  createTableOfContents(session) {
    const toc = document.createElement("div");
    toc.className = "pdf-toc page-break-after";
    toc.style.cssText = `
      all: revert;
      display: block;
      min-height: 297mm;
      padding: 20mm;
      box-sizing: border-box;
    `;

    let tocHTML = `
      <h1 style="
        font-size: 32pt;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 15mm;
        border-bottom: 3px solid #667eea;
        padding-bottom: 5mm;
      ">${this.T('toc_title')}</h1>
      <div style="font-size: 12pt; line-height: 1.8;">
    `;

    session.captures.forEach((capture, index) => {
      const stepTitle =
        capture.title?.replace(/\.png$/i, "") || `Step ${index + 1}`;
      tocHTML += `
        <div style="
          display: flex;
          justify-content: space-between;
          padding: 3mm 0;
          border-bottom: 1px dotted #e2e8f0;
        ">
          <span style="font-weight: 500;">
            ${index + 1}. ${this.escapeHtml(stepTitle)}
          </span>
          <span style="color: #94a3b8;">
            ${this.T('page')} ${index + 3}
          </span>
        </div>
      `;
    });

    tocHTML += "</div>";
    toc.innerHTML = tocHTML;
    return toc;
  }

  // Create step page with screenshot and description
  createStepPage(capture, stepNumber, session) {
    const page = document.createElement("div");
    page.className = "pdf-step-page page-break-after";
    page.style.cssText = `
      all: revert;
      display: block;
      min-height: 297mm;
      padding: 20mm;
      position: relative;
      box-sizing: border-box;
    `;

    const stepTitle =
      capture.title?.replace(/\.png$/i, "") || `Step ${stepNumber}`;
    const stepDescription =
      session.steps?.[stepNumber - 1] || this.T('no_description');

    page.innerHTML = `
      <!-- Header -->
      <div style="
        display: flex;
        align-items: center;
        margin-bottom: 10mm;
        padding-bottom: 5mm;
        border-bottom: 2px solid #667eea;
      ">
        <div style="
          width: 15mm;
          height: 15mm;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18pt;
          font-weight: 700;
          margin-right: 5mm;
        ">
          ${stepNumber}
        </div>
        <div>
          <div style="font-size: 20pt; font-weight: 700; color: #1e293b;">
            ${this.escapeHtml(stepTitle)}
          </div>
          <div style="font-size: 10pt; color: #94a3b8; margin-top: 1mm;">
            ${this.T('step_of', { n: stepNumber, total: session.captures.length })}
          </div>
        </div>
      </div>

      <!-- Screenshot -->
      <div style="
        margin-bottom: 10mm;
        text-align: center;
        background: #f8fafc;
        padding: 5mm;
        border-radius: 3mm;
        border: 1px solid #e2e8f0;
      ">
        <img 
          src="${capture.dataUrl}" 
          style="
            max-width: 100%;
            max-height: 150mm;
            border-radius: 2mm;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          "
          alt="Step ${stepNumber}"
        />
      </div>

      <!-- Description -->
      <div style="
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        padding: 5mm;
        border-radius: 3mm;
        border-left: 4px solid #667eea;
      ">
        <div style="
          font-size: 11pt;
          line-height: 1.6;
          color: #334155;
        ">
          ${this.escapeHtml(stepDescription)}
        </div>
      </div>

      <!-- Page number -->
      <div style="
        position: absolute;
        bottom: 10mm;
        right: 20mm;
        font-size: 10pt;
        color: #94a3b8;
      ">
        ${this.T('page')} ${stepNumber + 2}
      </div>
    `;

    return page;
  }

  // Create footer page
  createFooterPage(session) {
    const footer = document.createElement("div");
    footer.className = "pdf-footer-page";
    footer.style.cssText = `
      all: revert;
      display: flex;
      min-height: 297mm;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40mm;
      box-sizing: border-box;
    `;

    footer.innerHTML = `
      <div style="font-size: 36pt; font-weight: 700; margin-bottom: 10mm;">
        ${this.T('footer_title')}
      </div>
      
      <div style="font-size: 14pt; opacity: 0.9; margin-bottom: 20mm; line-height: 1.8;">
        ${this.T('footer_line1', { count: session.captures.length })}<br>
        ${this.T('footer_line2')}
      </div>

      <div style="
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 8mm;
        border-radius: 3mm;
        font-size: 11pt;
        opacity: 0.8;
      ">
        <div style="margin-bottom: 3mm;">${this.T('footer_support')}</div>
        <div style="margin-bottom: 3mm;">${this.T('footer_website')}</div>
        <div>${this.T('footer_rate')}</div>
      </div>

      <div style="margin-top: 20mm; font-size: 10pt; opacity: 0.6;">
        ${this.T('footer_generated_by')}<br>
        ${new Date().toLocaleDateString()}
      </div>
    `;

    return footer;
  }

  // Export with custom template
  async exportWithTemplate(session, template = "modern") {
    const templates = {
      modern: () => this.exportSession(session),
      minimal: () => this.exportMinimal(session),
      detailed: () => this.exportDetailed(session)
    };

    const exportFunc = templates[template] || templates.modern;
    await exportFunc();
  }

  // Minimal template (no cover page)
  async exportMinimal(session) {
    if (typeof html2pdf === 'undefined') {
      this.showNotification("âŒ PDF library not loaded. Please reload the extension.", "error");
      return;
    }

    await this.initI18n();

    const container = document.createElement("div");
    container.style.cssText = `
      all: initial;
      position: absolute;
      left: -9999px;
      width: 210mm;
      background: white;
      padding: 20mm;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      box-sizing: border-box;
    `;

    session.captures.forEach((capture, index) => {
      const stepDiv = document.createElement("div");
      stepDiv.className =
        index < session.captures.length - 1 ? "page-break-after" : "";
      stepDiv.style.cssText = "all: revert; display: block; box-sizing: border-box;";
      stepDiv.innerHTML = `
        <h2 style="color: #667eea; margin-bottom: 5mm; display: block;">
          ${this.T('step_word')} ${index + 1}: ${this.escapeHtml(capture.title?.replace(/\.png$/i, "") || "")}
        </h2>
        <img src="${capture.dataUrl}" style="max-width: 100%; margin-bottom: 5mm; border-radius: 2mm; display: block;" />
        <p style="color: #334155; line-height: 1.6; display: block;">
          ${this.escapeHtml(session.steps?.[index] || this.T('no_description'))}
        </p>
      `;
      container.appendChild(stepDiv);
    });

    document.body.appendChild(container);

    try {
      await html2pdf().set(this.defaultOptions).from(container).save();
      this.showNotification(this.T('pdf_min_success'), "success");
    } catch (error) {
      this.showNotification(this.T('pdf_fail'), "error");
    }

    setTimeout(() => container.remove(), 100);
  }

  // Detailed template (with notes and metadata)
  async exportDetailed(session) {
    // Similar to exportSession but with more details
    // Implementation would add rich notes, timestamps, etc.
    await this.exportSession(session);
  }

  // Utility functions
  sanitizeFilename(filename) {
    return filename.replace(/[^a-z0-9]/gi, "_").toLowerCase();
  }

  escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  showNotification(message, type = "info") {
    const notification = document.createElement("div");

    const colors = {
      success: "#10b981",
      error: "#ef4444",
      info: "#667eea"
    };

    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${colors[type] || colors.info};
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 2.7s;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;

    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
}

// Export for use in editor
window.PDFExporter = PDFExporter;
